<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’• çˆ±çš„ååº” Â· 236å¤©çºªå¿µ ğŸ’•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #gameCanvas {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
        }

        /* ç©å®¶è§’è‰² */
        #player {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        #player.dodge-up {
            transform: translate(-50%, -180%) !important;
        }

        #player.dodge-down {
            transform: translate(-50%, 80%) !important;
        }

        #player.dodge-left {
            transform: translate(-180%, -50%) !important;
        }

        #player.dodge-right {
            transform: translate(80%, -50%) !important;
        }

        #player.hurt {
            transform: translate(-50%, -50%) scale(0.8) !important;
            filter: brightness(0.5);
        }

        /* ç®­çŸ¢ */
        .arrow {
            position: absolute;
            width: 40px;
            height: 40px;
            font-size: 35px;
            transition: opacity 0.2s ease, filter 0.1s ease, transform 0.1s ease;
            z-index: 5;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.3));
        }

        .arrow.in-range {
            filter: drop-shadow(0 0 8px rgba(255, 59, 48, 0.8)) drop-shadow(0 2px 5px rgba(0, 0, 0, 0.3));
        }

        /* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
        #controls {
            position: relative;
            width: 100%;
            height: 280px;
            background: rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 10px;
            padding: 20px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            font-size: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
            touch-action: none;
        }

        .btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn.correct {
            animation: correctFlash 0.3s;
        }

        .btn.wrong {
            animation: wrongFlash 0.3s;
        }

        @keyframes correctFlash {
            0%, 100% { background: rgba(255, 255, 255, 0.9); }
            50% { background: rgba(76, 217, 100, 0.9); }
        }

        @keyframes wrongFlash {
            0%, 100% { background: rgba(255, 255, 255, 0.9); }
            50% { background: rgba(255, 59, 48, 0.9); }
        }

        #btnUp { grid-column: 2; grid-row: 1; }
        #btnLeft { grid-column: 1; grid-row: 2; }
        #btnDown { grid-column: 2; grid-row: 2; }
        #btnRight { grid-column: 3; grid-row: 2; }

        /* ä¿¡æ¯é¢æ¿ */
        #infoPanel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 20px;
            display: flex;
            gap: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 20;
            font-weight: bold;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
        }

        .info-value {
            font-size: 20px;
            color: #333;
        }

        /* ç”Ÿå‘½å€¼ */
        #hearts {
            font-size: 24px;
        }

        /* å¼€å§‹ç•Œé¢ */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            gap: 20px;
            padding: 20px;
        }

        #startScreen h1 {
            font-size: 32px;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #startScreen h2 {
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
        }

        #startScreen p {
            font-size: 15px;
            text-align: center;
            line-height: 1.9;
            max-width: 320px;
        }

        #startBtn {
            margin-top: 20px;
            padding: 15px 50px;
            font-size: 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: transform 0.2s;
        }

        #startBtn:active {
            transform: scale(0.95);
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            gap: 20px;
            padding: 20px;
        }

        #gameOverScreen h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        #gameOverScreen p {
            font-size: 18px;
            text-align: center;
        }

        #restartBtn {
            margin-top: 20px;
            padding: 15px 50px;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s;
        }

        #restartBtn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- å¼€å§‹ç•Œé¢ -->
        <div id="startScreen">
            <h1>ğŸ’• çˆ±çš„ååº” ğŸ’•</h1>
            <h2>æ‹çˆ±ç¬¬236å¤©çºªå¿µ</h2>
            <p>
                ğŸ’˜ æ¸¸æˆè§„åˆ™ ğŸ’˜<br><br>
                å››é¢å…«æ–¹ä¼šæœ‰ç®­çŸ¢å†²å‘ä½ <br>
                å¿«é€Ÿä¾§èº«é—ªé¿ï¼<br><br>
                â¬…ï¸â¡ï¸ å·¦å³ç®­å¤´ â†’ æŒ‰â¬†ï¸â¬‡ï¸é—ªé¿<br>
                â¬†ï¸â¬‡ï¸ ä¸Šä¸‹ç®­å¤´ â†’ æŒ‰â¬…ï¸â¡ï¸é—ªé¿<br><br>
                å°±åƒæˆ‘ä»¬çš„çˆ±æƒ…<br>
                éœ€è¦é»˜å¥‘é…åˆæ¯ä¸€ä¸ªç¬é—´
            </p>
            <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div id="gameOverScreen">
            <h1>æ¸¸æˆç»“æŸ</h1>
            <p id="finalScore"></p>
            <p id="loveMessage"></p>
            <button id="restartBtn">å†æ¥ä¸€æ¬¡</button>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <div id="gameCanvas">
            <!-- ä¿¡æ¯é¢æ¿ -->
            <div id="infoPanel">
                <div class="info-item">
                    <div class="info-label">åˆ†æ•°</div>
                    <div class="info-value" id="score">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç”Ÿå‘½</div>
                    <div id="hearts">â¤ï¸â¤ï¸â¤ï¸</div>
                </div>
                <div class="info-item">
                    <div class="info-label">è¿å‡»</div>
                    <div class="info-value" id="combo">0</div>
                </div>
            </div>

            <!-- ç©å®¶ -->
            <div id="player">ğŸ’‘</div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="btn" id="btnUp" data-direction="up">â¬†ï¸</button>
            <button class="btn" id="btnLeft" data-direction="left">â¬…ï¸</button>
            <button class="btn" id="btnDown" data-direction="down">â¬‡ï¸</button>
            <button class="btn" id="btnRight" data-direction="right">â¡ï¸</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const game = {
            score: 0,
            lives: 3,
            combo: 0,
            isPlaying: false,
            arrows: [],
            currentArrow: null,
            difficulty: 1,
            baseArrowSpeed: 1800, // åŸºç¡€ç®­çŸ¢é£è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            speedVariation: 200, // é€Ÿåº¦éšæœºå˜åŒ–èŒƒå›´
            spawnInterval: 2200, // ç”Ÿæˆé—´éš”
            spawnTimer: null,
            startTime: 0, // æ¸¸æˆå¼€å§‹æ—¶é—´
            dodgeWindow: 500, // é—ªé¿åˆ¤å®šçª—å£ï¼ˆæ¯«ç§’ï¼‰- ç®­å¤´åˆ°è¾¾ä¸­å¿ƒå‰åçš„æœ‰æ•ˆé—ªé¿æ—¶é—´
            collisionRadius: 35 // ç¢°æ’åŠå¾„ï¼ˆåƒç´ ï¼‰- ç®­å¤´ä¸ç©å®¶ä¸­å¿ƒçš„è·ç¦»å°äºæ­¤å€¼æ‰åˆ¤å®šç¢°æ’
        };

        // DOM å…ƒç´ 
        const elements = {
            startScreen: document.getElementById('startScreen'),
            gameOverScreen: document.getElementById('gameOverScreen'),
            startBtn: document.getElementById('startBtn'),
            restartBtn: document.getElementById('restartBtn'),
            gameCanvas: document.getElementById('gameCanvas'),
            player: document.getElementById('player'),
            score: document.getElementById('score'),
            hearts: document.getElementById('hearts'),
            combo: document.getElementById('combo'),
            finalScore: document.getElementById('finalScore'),
            loveMessage: document.getElementById('loveMessage'),
            btnUp: document.getElementById('btnUp'),
            btnLeft: document.getElementById('btnLeft'),
            btnDown: document.getElementById('btnDown'),
            btnRight: document.getElementById('btnRight')
        };

        // æ–¹å‘é…ç½®
        const directions = {
            up: { emoji: 'â¬†ï¸', startY: -50, startX: '50%', endY: '50%', endX: '50%', passY: window.innerHeight + 50 },
            down: { emoji: 'â¬‡ï¸', startY: window.innerHeight, startX: '50%', endY: '50%', endX: '50%', passY: -50 },
            left: { emoji: 'â¬…ï¸', startX: -50, startY: '50%', endX: '50%', endY: '50%', passX: window.innerWidth + 50 },
            right: { emoji: 'â¡ï¸', startX: window.innerWidth, startY: '50%', endX: '50%', endY: '50%', passX: -50 }
        };

        // çˆ±çš„è¯è¯­
        const loveMessages = [
            'æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ï¼Œå°±åƒé‡è§ä½  ğŸ’•',
            '236å¤©ï¼Œæ¯ä¸€å¤©éƒ½æ˜¯å¹¸ç¦ ğŸŒ¹',
            'ä½ çš„ååº”å°±åƒä½ å¯¹æˆ‘çš„çˆ±ä¸€æ ·æ•é” ğŸ’–',
            'æˆ‘ä»¬çš„çˆ±æƒ…éœ€è¦å½¼æ­¤çš„é»˜å¥‘å’Œå›åº” ğŸ’',
            'å°±åƒè¿™æ¸¸æˆï¼Œçˆ±æƒ…éœ€è¦ä¸“æ³¨å’Œç”¨å¿ƒ ğŸ’—',
            '236ä¸ªæ—¥å¤œï¼Œæ„Ÿè°¢æœ‰ä½ é™ªä¼´ ğŸŒŸ',
            'æ¯æ¬¡æ­£ç¡®çš„å›åº”ï¼Œå°±åƒæˆ‘ä»¬å¿ƒæœ‰çµçŠ€ ğŸ’«',
            'åœ¨çˆ±çš„ä¸–ç•Œé‡Œï¼Œä½ å°±æ˜¯æˆ‘çš„æ–¹å‘ ğŸ§­'
        ];

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            game.score = 0;
            game.lives = 3;
            game.combo = 0;
            game.isPlaying = true;
            game.arrows = [];
            game.difficulty = 1;
            game.baseArrowSpeed = 1800;
            game.speedVariation = 200;
            game.spawnInterval = 2200;
            game.startTime = Date.now();
            game.dodgeWindow = 500;
            game.collisionRadius = 35;

            updateUI();
            elements.startScreen.classList.add('hidden');
            elements.gameOverScreen.style.display = 'none';

            // æ¸…é™¤æ‰€æœ‰ç®­çŸ¢
            document.querySelectorAll('.arrow').forEach(arrow => arrow.remove());

            // å¼€å§‹ç”Ÿæˆç®­çŸ¢
            spawnArrow();
            scheduleNextArrow();
        }

        // ç”Ÿæˆç®­çŸ¢
        function spawnArrow() {
            if (!game.isPlaying) return;

            // è®¡ç®—æ¸¸æˆè¿›è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
            const elapsedTime = (Date.now() - game.startTime) / 1000;
            
            // éšç€æ—¶é—´å¢åŠ é€Ÿåº¦å˜åŒ–èŒƒå›´ï¼ˆæ¯10ç§’å¢åŠ 100mså˜åŒ–èŒƒå›´ï¼‰
            const currentVariation = game.speedVariation + Math.floor(elapsedTime / 10) * 100;
            
            // éšæœºé€Ÿåº¦ï¼šåŸºç¡€é€Ÿåº¦ Â± å˜åŒ–èŒƒå›´
            const randomSpeed = game.baseArrowSpeed + (Math.random() * 2 - 1) * currentVariation;
            const arrowSpeed = Math.max(800, Math.min(2500, randomSpeed)); // é™åˆ¶åœ¨800-2500msä¹‹é—´

            const directionKeys = Object.keys(directions);
            const randomDirection = directionKeys[Math.floor(Math.random() * directionKeys.length)];
            const config = directions[randomDirection];

            const arrow = document.createElement('div');
            arrow.className = 'arrow';
            arrow.innerHTML = config.emoji;
            arrow.dataset.direction = randomDirection;
            arrow.dataset.dodged = 'false';
            arrow.dataset.speed = arrowSpeed; // è®°å½•è¿™ä¸ªç®­å¤´çš„é€Ÿåº¦

            // è®¾ç½®åˆå§‹ä½ç½®
            if (randomDirection === 'up' || randomDirection === 'down') {
                arrow.style.left = config.startX;
                arrow.style.transform = 'translateX(-50%)';
                arrow.style.top = config.startY + 'px';
            } else {
                arrow.style.top = config.startY;
                arrow.style.transform = 'translateY(-50%)';
                arrow.style.left = config.startX + 'px';
            }

            elements.gameCanvas.appendChild(arrow);

            // åŠ¨ç”»é£å‘ä¸­å¿ƒï¼Œç„¶åç»§ç»­é£è¿‡å»
            setTimeout(() => {
                arrow.style.transition = `all ${arrowSpeed}ms linear`;
                arrow.style.left = config.endX;
                arrow.style.top = config.endY;
                arrow.style.transform = 'translate(-50%, -50%)';
            }, 50);

            // è®¾ç½®ä¸ºå½“å‰ç®­çŸ¢
            game.currentArrow = {
                element: arrow,
                direction: randomDirection,
                timestamp: Date.now(),
                speed: arrowSpeed,
                arrivalTime: Date.now() + arrowSpeed + 50 // é¢„è®¡åˆ°è¾¾ä¸­å¿ƒçš„æ—¶é—´
            };

            // æŒç»­æ£€æŸ¥ç¢°æ’
            const collisionCheckInterval = setInterval(() => {
                if (!arrow.parentNode || !game.isPlaying) {
                    clearInterval(collisionCheckInterval);
                    return;
                }
                
                const distance = getDistanceToPlayer(arrow);
                
                // ç®­å¤´è¿›å…¥å¯é—ªé¿èŒƒå›´æ—¶æ·»åŠ è§†è§‰æç¤º
                if (distance <= game.collisionRadius * 2.5 && distance > game.collisionRadius) {
                    arrow.classList.add('in-range');
                } else {
                    arrow.classList.remove('in-range');
                }
                
                // ç®­å¤´è¿›å…¥ç¢°æ’åŠå¾„
                if (distance <= game.collisionRadius) {
                    clearInterval(collisionCheckInterval);
                    arrow.classList.remove('in-range');
                    
                    if (arrow.dataset.dodged === 'false') {
                        // æœªé—ªé¿ï¼Œå¤±å»ç”Ÿå‘½
                        loseLife();
                    }
                    
                    // ç»§ç»­é£è¿‡å»
                    setTimeout(() => {
                        if (arrow.parentNode) {
                            arrow.style.transition = `all ${arrowSpeed}ms linear`;
                            if (randomDirection === 'up' || randomDirection === 'down') {
                                arrow.style.top = config.passY + 'px';
                            } else {
                                arrow.style.left = config.passX + 'px';
                            }
                        }
                    }, 100);
                    
                    game.currentArrow = null;
                }
            }, 16); // æ¯16msæ£€æŸ¥ä¸€æ¬¡ï¼ˆçº¦60fpsï¼‰
            
            // ä¿é™©æœºåˆ¶ï¼šç®­å¤´é£è¡Œæ—¶é—´ç»“æŸåå¼ºåˆ¶æ¸…é™¤æ£€æŸ¥
            setTimeout(() => {
                clearInterval(collisionCheckInterval);
                if (game.currentArrow?.element === arrow) {
                    game.currentArrow = null;
                }
            }, arrowSpeed + 200);

            // ç®­çŸ¢é£å‡ºå±å¹•åç§»é™¤
            setTimeout(() => {
                if (arrow.parentNode) {
                    arrow.remove();
                }
            }, arrowSpeed * 2 + 100);
        }

        // å®‰æ’ä¸‹ä¸€ä¸ªç®­çŸ¢
        function scheduleNextArrow() {
            if (!game.isPlaying) return;

            // è®¡ç®—æ¸¸æˆè¿›è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
            const elapsedTime = (Date.now() - game.startTime) / 1000;
            
            // éšç€æ—¶é—´å¢åŠ éš¾åº¦ï¼šåŸºç¡€é€Ÿåº¦å˜å¿«ï¼Œç”Ÿæˆé—´éš”å˜çŸ­
            const difficultyIncrease = Math.floor(elapsedTime / 15) * 100; // æ¯15ç§’å¢åŠ 100mséš¾åº¦
            game.baseArrowSpeed = Math.max(1200, 1800 - difficultyIncrease);
            game.spawnInterval = Math.max(1300, 2200 - difficultyIncrease * 1.2);
            
            // ç¼©å°é—ªé¿çª—å£ï¼Œè®©åˆ¤å®šè¶Šæ¥è¶Šä¸¥æ ¼
            game.dodgeWindow = Math.max(280, 500 - Math.floor(elapsedTime / 20) * 35);

            game.spawnTimer = setTimeout(() => {
                spawnArrow();
                scheduleNextArrow();
            }, game.spawnInterval);
        }

        // è®¡ç®—ç®­å¤´ä¸ç©å®¶ä¸­å¿ƒçš„è·ç¦»
        function getDistanceToPlayer(arrowElement) {
            const arrowRect = arrowElement.getBoundingClientRect();
            const playerRect = elements.player.getBoundingClientRect();
            
            // è®¡ç®—ç®­å¤´å’Œç©å®¶çš„ä¸­å¿ƒç‚¹
            const arrowCenterX = arrowRect.left + arrowRect.width / 2;
            const arrowCenterY = arrowRect.top + arrowRect.height / 2;
            const playerCenterX = playerRect.left + playerRect.width / 2;
            const playerCenterY = playerRect.top + playerRect.height / 2;
            
            // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»
            const dx = arrowCenterX - playerCenterX;
            const dy = arrowCenterY - playerCenterY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // åˆ¤æ–­é—ªé¿æ–¹å‘æ˜¯å¦æ­£ç¡®
        function isCorrectDodge(arrowDirection, dodgeDirection) {
            // å·¦å³æ¥çš„ç®­å¤´ï¼Œéœ€è¦ä¸Šä¸‹é—ªé¿
            if (arrowDirection === 'left' || arrowDirection === 'right') {
                return dodgeDirection === 'up' || dodgeDirection === 'down';
            }
            // ä¸Šä¸‹æ¥çš„ç®­å¤´ï¼Œéœ€è¦å·¦å³é—ªé¿
            if (arrowDirection === 'up' || arrowDirection === 'down') {
                return dodgeDirection === 'left' || dodgeDirection === 'right';
            }
            return false;
        }

        // å¤„ç†æ–¹å‘æŒ‰é’®ç‚¹å‡»
        function handleDirectionClick(clickedDirection) {
            if (!game.isPlaying || !game.currentArrow) return;

            const arrow = game.currentArrow;
            const btn = document.querySelector(`[data-direction="${clickedDirection}"]`);
            
            // è®¡ç®—ç®­å¤´ä¸ç©å®¶çš„å®é™…è·ç¦»
            const distance = getDistanceToPlayer(arrow.element);
            
            // è·ç¦»åˆ¤å®šï¼šç®­å¤´å¿…é¡»è¶³å¤Ÿæ¥è¿‘ç©å®¶æ‰èƒ½é—ªé¿ï¼ˆå…è®¸è·ç¦»=ç¢°æ’åŠå¾„çš„2.5å€ï¼‰
            if (distance > game.collisionRadius * 2.5) {
                // ç®­å¤´è¿˜å¤ªè¿œï¼Œä¸ç®—
                return;
            }
            
            // è®¡ç®—å½“å‰æ—¶é—´ä¸ç®­å¤´åˆ°è¾¾æ—¶é—´çš„å·®è·
            const currentTime = Date.now();
            const timeUntilArrival = arrow.arrivalTime - currentTime;
            
            // åˆ¤æ–­æ˜¯å¦åœ¨æœ‰æ•ˆé—ªé¿çª—å£å†…ï¼ˆç®­å¤´åˆ°è¾¾ä¸­å¿ƒå‰åçš„ä¸€æ®µæ—¶é—´ï¼‰
            const isInDodgeWindow = Math.abs(timeUntilArrival) <= game.dodgeWindow;

            if (!isInDodgeWindow) {
                // å¤ªæ—©æˆ–å¤ªæ™šæŒ‰é”®ï¼Œä¸ç®—
                return;
            }

            if (isCorrectDodge(arrow.direction, clickedDirection)) {
                // æ­£ç¡®é—ªé¿
                // æ ¹æ®æ—¶æœºç»™åˆ†ï¼šè¶Šæ¥è¿‘å®Œç¾æ—¶æœºåˆ†æ•°è¶Šé«˜
                const perfectBonus = Math.max(0, 1 - Math.abs(timeUntilArrival) / game.dodgeWindow);
                const baseScore = 1 + Math.floor(game.combo / 5);
                const scoreGained = Math.ceil(baseScore * (1 + perfectBonus));
                
                game.score += scoreGained;
                game.combo++;
                
                btn.classList.add('correct');
                setTimeout(() => btn.classList.remove('correct'), 300);

                // æ ‡è®°ç®­çŸ¢ä¸ºå·²é—ªé¿ï¼ˆä¸ç§»é™¤ï¼‰
                arrow.element.dataset.dodged = 'true';
                
                // è®©ç®­å¤´å˜æ·¡ï¼Œè¡¨ç¤ºé—ªé¿æˆåŠŸ
                arrow.element.style.opacity = '0.3';

                // åˆ›å»ºæˆåŠŸç²’å­æ•ˆæœ
                const playerRect = elements.player.getBoundingClientRect();
                createParticles('ğŸ’–', playerRect.left + playerRect.width / 2, playerRect.top + playerRect.height / 2);

                // ç©å®¶é—ªé¿åŠ¨ç”»
                elements.player.classList.remove('dodge-up', 'dodge-down', 'dodge-left', 'dodge-right', 'hurt');
                elements.player.classList.add(`dodge-${clickedDirection}`);
                
                setTimeout(() => {
                    elements.player.classList.remove(`dodge-${clickedDirection}`);
                }, 300);

            } else {
                // é”™è¯¯æ–¹å‘
                game.combo = 0;
                btn.classList.add('wrong');
                setTimeout(() => btn.classList.remove('wrong'), 300);
            }

            updateUI();
        }

        // å¤±å»ç”Ÿå‘½
        function loseLife() {
            game.lives--;
            game.combo = 0;
            updateUI();

            // ç©å®¶å—ä¼¤åŠ¨ç”»
            elements.player.classList.remove('dodge-up', 'dodge-down', 'dodge-left', 'dodge-right');
            elements.player.classList.add('hurt');
            
            setTimeout(() => {
                elements.player.classList.remove('hurt');
            }, 300);

            if (game.lives <= 0) {
                gameOver();
            }
        }

        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(emoji, x, y) {
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.innerHTML = emoji;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.fontSize = '20px';

                const angle = (Math.PI * 2 * i) / 8;
                const distance = 50 + Math.random() * 30;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animation = 'particleFloat 0.6s ease-out forwards';

                elements.gameCanvas.appendChild(particle);

                setTimeout(() => particle.remove(), 600);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            elements.score.textContent = game.score;
            elements.combo.textContent = game.combo;
            
            const heartStr = 'â¤ï¸'.repeat(game.lives) + 'ğŸ–¤'.repeat(3 - game.lives);
            elements.hearts.innerHTML = heartStr;
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            game.isPlaying = false;
            clearTimeout(game.spawnTimer);

            // æ¸…é™¤æ‰€æœ‰ç®­çŸ¢
            document.querySelectorAll('.arrow').forEach(arrow => arrow.remove());

            // æ˜¾ç¤ºç»“æŸç•Œé¢
            elements.finalScore.textContent = `æœ€ç»ˆå¾—åˆ†ï¼š${game.score} åˆ†`;
            
            const randomMessage = loveMessages[Math.floor(Math.random() * loveMessages.length)];
            elements.loveMessage.textContent = randomMessage;

            setTimeout(() => {
                elements.gameOverScreen.style.display = 'flex';
            }, 500);
        }

        // äº‹ä»¶ç›‘å¬
        elements.startBtn.addEventListener('click', startGame);
        elements.restartBtn.addEventListener('click', startGame);

        // æ–¹å‘æŒ‰é’®äº‹ä»¶
        [elements.btnUp, elements.btnDown, elements.btnLeft, elements.btnRight].forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleDirectionClick(btn.dataset.direction);
            });
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                handleDirectionClick(btn.dataset.direction);
            });
        });

        // é˜²æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        // åˆå§‹åŒ–
        updateUI();
    </script>
</body>
</html>
